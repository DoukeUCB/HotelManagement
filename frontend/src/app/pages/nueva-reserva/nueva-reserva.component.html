<div class="main-container">
  <header class="page-header">
    <a routerLink="/reservas" class="link-back">‹ Volver</a>
    <h1>Nueva reserva</h1>
    <span class="header-placeholder"></span>
  </header>

  <section *ngIf="catalogosCargando(); else contenido" class="estado">
    Cargando catálogos...
  </section>

  <ng-template #contenido>
    <section *ngIf="error(); else formulario" class="estado estado-error">
      {{ error() }}
    </section>

    <ng-template #formulario>
      <form [formGroup]="form" (ngSubmit)="crearReserva()" class="card form-reserva">
        <h2 class="section-lead">
          <span class="bullet">1</span>
          Datos generales
          <small>Elige quién realiza la reserva y la habitación asignada</small>
        </h2>

        <div class="grid">
          <label class="field">
            <span>Cliente</span>
            <select formControlName="clienteId">
              <option value="" disabled>Selecciona un cliente</option>
              <option *ngFor="let c of clientes()" [value]="c.id">
                {{ c.label }} — {{ c.email }}
              </option>
            </select>
            <small *ngIf="form.controls.clienteId.invalid && form.controls.clienteId.touched">
              Campo obligatorio.
            </small>
          </label>

          <label class="field">
            <span>Habitación</span>
            <select formControlName="habitacionId">
              <option value="" disabled>Selecciona una habitación</option>
              <option *ngFor="let h of habitaciones()" [value]="h.id">
                Hab. {{ h.numero }} — {{ h.estado }}
              </option>
            </select>
            <small *ngIf="form.controls.habitacionId.invalid && form.controls.habitacionId.touched">
              Campo obligatorio.
            </small>
          </label>

          <label class="field">
            <span>Huésped</span>
            <select formControlName="huespedId">
              <option value="" disabled>Selecciona al huésped principal</option>
              <option *ngFor="let h of huespedes()" [value]="h.id">
                {{ h.nombre }}
              </option>
            </select>
            <small *ngIf="form.controls.huespedId.invalid && form.controls.huespedId.touched">
              Campo obligatorio.
            </small>
          </label>

          <label class="field">
            <span>Estado</span>
            <select formControlName="estadoReserva">
              <option *ngFor="let estado of estadosReserva" [value]="estado">
                {{ estado }}
              </option>
            </select>
          </label>
        </div>

        <h2 class="section-lead">
          <span class="bullet">2</span>
          Fechas
          <small>Define estancia y número de huéspedes</small>
        </h2>
        <div class="grid">
          <label class="field">
            <span>Fecha de entrada</span>
            <input type="date" formControlName="fechaEntrada" />
            <small *ngIf="form.controls.fechaEntrada.invalid && form.controls.fechaEntrada.touched">
              Campo obligatorio.
            </small>
          </label>

          <label class="field">
            <span>Fecha de salida</span>
            <input type="date" formControlName="fechaSalida" />
            <small *ngIf="form.controls.fechaSalida.invalid && form.controls.fechaSalida.touched">
              Campo obligatorio.
            </small>
          </label>

          <label class="field">
            <span>Cant. huéspedes</span>
            <input type="number" min="1" formControlName="cantidadHuespedes" />
            <small
              *ngIf="form.controls.cantidadHuespedes.invalid && form.controls.cantidadHuespedes.touched"
            >
              Debe ser al menos 1.
            </small>
          </label>
        </div>

        <h2 class="section-lead">
          <span class="bullet">3</span>
          Montos
          <small>Introduce los importes acordados</small>
        </h2>
        <div class="grid">
          <label class="field">
            <span>Monto total de la reserva (Bs.)</span>
            <input type="number" min="0" step="0.01" formControlName="montoTotal" />
            <small *ngIf="form.controls.montoTotal.invalid && form.controls.montoTotal.touched">
              Ingresa un monto válido.
            </small>
          </label>

          <label class="field">
            <span>Precio del detalle (Bs.)</span>
            <input type="number" min="0" step="0.01" formControlName="precioDetalle" />
            <small *ngIf="form.controls.precioDetalle.invalid && form.controls.precioDetalle.touched">
              Ingresa un monto válido.
            </small>
          </label>
        </div>

        <div class="acciones">
          <button type="button" class="btn btn-tertiary" (click)="volverAlListado()">
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="submitting()">
            <span class="spinner" *ngIf="submitting(); else label"></span>
            <ng-template #label>{{ submitting() ? 'Guardando…' : 'Guardar reserva' }}</ng-template>
          </button>
        </div>

        <p *ngIf="mensaje()" class="estado estado-ok">{{ mensaje() }}</p>
        <p *ngIf="error()" class="estado estado-error">{{ error() }}</p>
      </form>
    </ng-template>
  </ng-template>
</div>
